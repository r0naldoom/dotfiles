#!/usr/bin/env bash
# Sincroniza tema do Noctalia com Ghostty, Neovim, Tmux, Yazi, Wallpaper e Bookokrat

set -euo pipefail

SETTINGS_FILE="$HOME/.config/noctalia/settings.json"
GHOSTTY_CONFIG="$HOME/.config/ghostty/config"
NVIM_THEME_FILE="$HOME/.config/nvim/lua/current-theme.lua"
TMUX_COLORS="$HOME/.config/tmux/noctalia-colors.conf"
TMUX_THEMES_DIR="$HOME/.config/tmux/themes"
YAZI_THEME="$HOME/.config/yazi/theme.toml"
YAZI_THEMES_DIR="$HOME/.config/yazi/themes"
WALLPAPERS_DIR="$HOME/Pictures/Wallpapers"
BOOKOKRAT_CONFIG="$HOME/.bookokrat_settings.yaml"

# Lê o tema atual do Noctalia
get_noctalia_theme() {
    grep '"predefinedScheme"' "$SETTINGS_FILE" | sed 's/.*: *"\([^"]*\)".*/\1/'
}

# Mapeamento Noctalia -> Neovim
map_nvim_theme() {
    case "$1" in
        "EfCherie")       echo "ef-cherie" ;;
        "EfMarisDark")    echo "ef-maris-dark" ;;
        "EfMelissaDark")  echo "ef-melissa-dark" ;;
        "EfNight")        echo "ef-night" ;;
        "Tokyo Night")    echo "tokyonight-night" ;;
        "Catppuccin"*)    echo "catppuccin" ;;
        "Gruvbox"*)       echo "gruvbox-material" ;;
        *)                echo "ef-cherie" ;;  # fallback
    esac
}

# Mapeamento Noctalia -> Ghostty
map_ghostty_theme() {
    case "$1" in
        "EfCherie")       echo "ef-cherie" ;;
        "EfMarisDark")    echo "ef-maris-dark" ;;
        "EfMelissaDark")  echo "ef-melissa-dark" ;;
        "EfNight")        echo "ef-night" ;;
        "Tokyo Night")    echo "TokyoNight" ;;
        "Catppuccin"*)    echo "catppuccin-mocha" ;;
        "Gruvbox"*)       echo "Gruvbox Material Dark" ;;
        *)                echo "ef-cherie" ;;  # fallback
    esac
}

# Mapeamento Noctalia -> Tmux
map_tmux_theme() {
    case "$1" in
        "EfCherie")       echo "ef-cherie" ;;
        "Tokyo Night")    echo "tokyonight" ;;
        "Gruvbox"*)       echo "gruvbox-material" ;;
        *)                echo "ef-cherie" ;;  # fallback
    esac
}

# Mapeamento Noctalia -> Yazi
map_yazi_theme() {
    case "$1" in
        "EfCherie")       echo "ef-cherie" ;;
        "Tokyo Night")    echo "tokyonight" ;;
        "Gruvbox"*)       echo "gruvbox-material" ;;
        *)                echo "ef-cherie" ;;  # fallback
    esac
}

# Mapeamento Noctalia -> Wallpaper
map_wallpaper() {
    case "$1" in
        "EfCherie")       echo "aaron-burden-cross-cherie.jpg" ;;
        "Tokyo Night")    echo "aaron-burden-cross-tokyo.jpg" ;;
        "Gruvbox"*)       echo "gabi-repaska-cross-gruvbox.jpg" ;;
        *)                echo "aaron-burden-cross-cherie.jpg" ;;  # fallback
    esac
}

# Mapeamento Noctalia -> Bookokrat
map_bookokrat_theme() {
    case "$1" in
        "EfCherie")       echo "EfCherie" ;;
        "Tokyo Night")    echo "TokyoNight" ;;
        "Gruvbox"*)       echo "GruvboxMaterial" ;;
        *)                echo "EfCherie" ;;  # fallback
    esac
}

# Atualiza tema do Ghostty
update_ghostty() {
    local theme="$1"

    if grep -q "^theme = " "$GHOSTTY_CONFIG" 2>/dev/null; then
        sed -i "s/^theme = .*/theme = $theme/" "$GHOSTTY_CONFIG"
    else
        echo "theme = $theme" >> "$GHOSTTY_CONFIG"
    fi

    # Recarrega Ghostty (SIGUSR2, não USR1!)
    pkill -USR2 ghostty 2>/dev/null || true
}

# Atualiza tema do Neovim
update_nvim() {
    local theme="$1"

    mkdir -p "$(dirname "$NVIM_THEME_FILE")"
    cat > "$NVIM_THEME_FILE" << EOF
-- Auto-generated by noctalia-theme-sync
-- DO NOT EDIT MANUALLY
return "$theme"
EOF

    # Notifica Neovim via socket fixo
    local sock="/tmp/nvim-${USER}.sock"
    if [[ -S "$sock" ]]; then
        nvim --server "$sock" --remote-send "<Cmd>lua require('noctalia-sync').apply()<CR>" 2>/dev/null || true
    fi
}

# Atualiza tema do Tmux
update_tmux() {
    local theme="$1"
    local theme_file="$TMUX_THEMES_DIR/$theme.conf"

    if [[ -f "$theme_file" ]]; then
        cp "$theme_file" "$TMUX_COLORS"
        # Recarrega tmux se estiver rodando
        if tmux info &>/dev/null; then
            tmux source-file ~/.config/tmux/tmux.conf 2>/dev/null || true
            tmux refresh-client -S 2>/dev/null || true
        fi
    fi
}

# Atualiza tema do Yazi
update_yazi() {
    local theme="$1"
    local theme_file="$YAZI_THEMES_DIR/$theme.toml"

    if [[ -f "$theme_file" ]]; then
        cp "$theme_file" "$YAZI_THEME"
    fi
}

# Atualiza wallpaper
update_wallpaper() {
    local wallpaper="$1"
    local wallpaper_path="$WALLPAPERS_DIR/$wallpaper"
    local cache_file="$HOME/.cache/noctalia/wallpapers.json"

    if [[ -f "$wallpaper_path" ]]; then
        # Atualiza o cache do Noctalia
        if [[ -f "$cache_file" ]]; then
            python3 -c "
import json
with open('$cache_file', 'r') as f:
    data = json.load(f)
for monitor in data.get('wallpapers', {}):
    data['wallpapers'][monitor] = '$wallpaper_path'
with open('$cache_file', 'w') as f:
    json.dump(data, f, indent=4)
" 2>/dev/null || true
        fi
        # Sempre reinicia swww-daemon (trava silenciosamente)
        pkill -9 swww-daemon 2>/dev/null || true
        sleep 1
        swww-daemon &>/dev/null &
        disown
        sleep 2
        swww img "$wallpaper_path" --transition-type grow --transition-pos center --transition-duration 1 2>/dev/null || true
    fi
}

# Atualiza tema do Bookokrat
update_bookokrat() {
    local theme="$1"

    if [[ -f "$BOOKOKRAT_CONFIG" ]]; then
        sed -i "s/^theme: .*/theme: \"$theme\"/" "$BOOKOKRAT_CONFIG"
        # bookokrat não recarrega config em hot — tema aplica na próxima abertura
    fi
}

main() {
    local noctalia_theme
    noctalia_theme=$(get_noctalia_theme)

    echo "Noctalia theme: $noctalia_theme"

    local nvim_theme ghostty_theme tmux_theme yazi_theme wallpaper bookokrat_theme
    nvim_theme=$(map_nvim_theme "$noctalia_theme")
    ghostty_theme=$(map_ghostty_theme "$noctalia_theme")
    tmux_theme=$(map_tmux_theme "$noctalia_theme")
    yazi_theme=$(map_yazi_theme "$noctalia_theme")
    wallpaper=$(map_wallpaper "$noctalia_theme")
    bookokrat_theme=$(map_bookokrat_theme "$noctalia_theme")

    echo "  -> Neovim: $nvim_theme"
    echo "  -> Ghostty: $ghostty_theme"
    echo "  -> Tmux: $tmux_theme"
    echo "  -> Yazi: $yazi_theme"
    echo "  -> Wallpaper: $wallpaper"
    echo "  -> Bookokrat: $bookokrat_theme"

    update_ghostty "$ghostty_theme"
    update_nvim "$nvim_theme"
    update_tmux "$tmux_theme"
    update_yazi "$yazi_theme"
    update_wallpaper "$wallpaper"
    update_bookokrat "$bookokrat_theme"

    echo "Done!"
}

main "$@"
